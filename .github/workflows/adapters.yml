name: SDK Adapters CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters.yml'
    tags:
      - 'v*'
  pull_request:
    branches: [main]
    paths:
      - 'adapters/**'

jobs:
  # ==================== Android ====================
  android-build:
    name: Android Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android Adapters
        working-directory: ./adapters/android
        run: ./gradlew build

      - name: Run Android Tests
        working-directory: ./adapters/android
        run: ./gradlew test

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-adapters
          path: |
            adapters/android/starbidz-core/build/outputs/aar/
            adapters/android/starbidz-max/build/outputs/aar/
            adapters/android/starbidz-admob/build/outputs/aar/
            adapters/android/starbidz-levelplay/build/outputs/aar/

  android-publish:
    name: Android Publish
    runs-on: ubuntu-latest
    needs: [android-build]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Publish to Maven Central
        working-directory: ./adapters/android
        run: ./gradlew publish
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}

  # ==================== iOS ====================
  ios-build:
    name: iOS Build
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build iOS Adapters
        working-directory: ./adapters/ios
        run: |
          swift build -c release

      - name: Run iOS Tests
        working-directory: ./adapters/ios
        run: |
          swift test

      - name: Build XCFramework
        working-directory: ./adapters/ios
        run: |
          # Build for iOS
          xcodebuild archive \
            -scheme Starbidz \
            -destination "generic/platform=iOS" \
            -archivePath build/Starbidz-iOS \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          # Build for iOS Simulator
          xcodebuild archive \
            -scheme Starbidz \
            -destination "generic/platform=iOS Simulator" \
            -archivePath build/Starbidz-Simulator \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          # Create XCFramework
          xcodebuild -create-xcframework \
            -framework build/Starbidz-iOS.xcarchive/Products/Library/Frameworks/Starbidz.framework \
            -framework build/Starbidz-Simulator.xcarchive/Products/Library/Frameworks/Starbidz.framework \
            -output build/Starbidz.xcframework
        continue-on-error: true # XCFramework build may need project setup

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-adapters
          path: adapters/ios/build/

  ios-publish:
    name: iOS Publish (CocoaPods)
    runs-on: macos-14
    needs: [ios-build]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup CocoaPods
        run: gem install cocoapods

      - name: Publish to CocoaPods
        working-directory: ./adapters/ios
        run: |
          pod trunk push Starbidz.podspec --allow-warnings
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        continue-on-error: true # Podspec may not exist yet

  # ==================== Release ====================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [android-build, ios-build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-adapters
          path: ./release/android

      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-adapters
          path: ./release/ios

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            release/android/**/*.aar
            release/ios/**/*.xcframework
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
